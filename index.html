<!doctype html>
<html>
    <body>
        <style>
            #page {
                display: inline;
            }
            #stats {
                display: none;
            }
            #rank {
                display: block;
            }
            #xp {
                text-decoration: underline;
            }
        </style>
            <div id="nav">
                <button onclick="switch_view()"><</button>
                <p id="page">Ranks</p>
                <button onclick="switch_view()">></button>
            </div>
            <div id="rank">
                <table id="ranks_table">
                    <tr>
                        <td>Platz</td>
                        <td>Name</td>
                        <td class="rank_col" id="xp" onclick="new_sort_rank(this)">XP</td>
                        <td class="rank_col" id="kills" onclick="new_sort_rank(this)">Kills</td>
                        <td class="rank_col" id="currentKillStreak" onclick="new_sort_rank(this)">Killstreak</td>
                        <td class="rank_col" id="bounty" onclick="new_sort_rank(this)">Kopfgeld</td>
                    </tr>
                </table>
                <button id="load_more" onclick="fill_rank()">Mehr laden</button>
            </div>
            <div id="stats">
                <input id="input" type="text" placeholder="name / uuid">
                <button onclick="load_stats()">Laden</button>
                <table id="main_stats_table">
                    <tr>
                        <td>Name:</td>
                        <td id="stats_name"></td>
                    </tr>
                    <tr>
                        <td>XP:</td>
                        <td id="stats_xp"></td>
                    </tr>
                    <tr>
                        <td>Kills:</td>
                        <td id="stats_kills"></td>
                    </tr>
                    <tr>
                        <td>Killstreak:</td>
                        <td id="stats_streak"></td>
                    </tr>
                    <tr>
                        <td>max. Killstreak:</td>
                        <td id="stats_max_streak"></td>
                    </tr>
                    <tr>
                        <td>Tode:</td>
                        <td id="stats_deaths"></td>
                    </tr>
                    <tr>
                        <td>Kopfgeld (XP):</td>
                        <td id="stats_bounty"></td>
                    </tr>
                </table>
            </div>
        <script>
            async function get_player(id){
                const response = await fetch(`https://api.ashcon.app/mojang/v2/user/${id}`)
                if (response.ok){
                    let player = await response.json()
                    return [player.uuid, player.username]
                } else {
                    throw new Error("nicht gefunden")
                }
            }

            async function fill_rank(sort_by="kills"){
                const response = await fetch(`https://api.hglabor.de/stats/ffa/top?sort=${sort_by}`)
                if (response.ok){
                    const list = await response.json()
                    var start = 15 * new_loads
                    if (start + 15 >= list.length){
                        document.getElementById("load_more").style.display = "none"
                    }
                    var table = document.getElementById("ranks_table")
                    await Promise.all(
                        list.slice(start, start + 15).map(async (item, index) => {
                            row = table.insertRow(-1)
                            row.className = "rank_row"
                            row.innerHTML = await add_rank_item(index + 1 + start, item)
                        })
                    )
                    document.querySelectorAll(".rank_name").forEach(name => { name.addEventListener("click", event => {
                            document.getElementById("input").value = event.target.innerText
                            switch_view()
                            load_stats()
                        })
                    })
                    new_loads += 1
                }
            }

            async function add_rank_item(id, player){
                let name = await get_player(player.playerId)
                html = `
                <tr>
                    <td>${id}</td>
                    <td class="rank_name">${name[1]}</td>
                    <td>${player.xp}</td>
                    <td>${player.kills}</td>
                    <td>${player.currentKillStreak}</td>
                    <td>${player.bounty}</td>
                <tr>
                `
                return html
            }

            async function load_stats(){
                input = document.getElementById("input").value
                if (input){
                    let [id, name] = await get_player(input)
                    const response = await fetch(`https://api.hglabor.de/stats/ffa/${id}`)
                    if (!response.ok) throw Error("nicht gefunden")
                    const player = await response.json()
                    document.getElementById("stats_name").innerText = name
                    document.getElementById("stats_xp").innerText = player.xp
                    document.getElementById("stats_kills").innerText = player.kills
                    document.getElementById("stats_streak").innerText = player.currentKillStreak
                    document.getElementById("stats_max_streak").innerText = player.highestKillStreak
                    document.getElementById("stats_deaths").innerText = player.deaths
                    document.getElementById("stats_bounty").innerText = player.bounty
                }
            }

            function switch_view(){
                const rank = document.getElementById("rank")
                const stats = document.getElementById("stats")
                if (rank.style.display === "none"){
                    rank.style.display = "block"
                    stats.style.display = "none"
                    document.getElementById("page").innerText = "Rank"
                } else {
                    stats.style.display = "block"
                    rank.style.display = "none"
                    document.getElementById("page").innerText = "Stats"
                }
            }

            function new_sort_rank(e){
                document.querySelectorAll(".rank_row").forEach(row => { 
                    document.getElementById("ranks_table").deleteRow(row.rowIndex)
                })
                document.querySelectorAll(".rank_col").forEach(element => {
                    element.style.setProperty("text-decoration", "none")
                })
                e.style.setProperty("text-decoration", "underline")
                
                new_loads = 0
                fill_rank(e.id)
            }

            var new_loads = 0
            fill_rank()
        </script>
    </body>
</html>
