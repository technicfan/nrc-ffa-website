<!doctype html>
<html>
    <body>
        <style>
            #page {
                display: inline;
            }
            #stats {
                display: none;
            }
            #rank {
                display: block;
            }
        </style>
            <div id="nav">
                <button onclick="switch_view()"><</button>
                <p id="page">Ranks</p>
                <button onclick="switch_view()">></button>
            </div>
            <div id="rank">
                <table id="ranks_table">
                    <tr>
                        <td>Platz</td>
                        <td>Name</td>
                        <td>XP</td>
                        <td>Kills</td>
                        <td>Killstreak</td>
                        <td>Kopfgeld</td>
                    </tr>
                </table>
            </div>
            <div id="stats">
                <input id="input" type="text" placeholder="name / uuid">
                <button onclick="load_stats()">Laden</button>
                <table id="main_stats_table">
                    <tr>
                        <td>Name:</td>
                        <td id="stats_name"></td>
                    </tr>
                    <tr>
                        <td>XP:</td>
                        <td id="stats_xp"></td>
                    </tr>
                    <tr>
                        <td>Kills:</td>
                        <td id="stats_kills"></td>
                    </tr>
                    <tr>
                        <td>Killstreak:</td>
                        <td id="stats_streak"></td>
                    </tr>
                    <tr>
                        <td>max. Killstreak:</td>
                        <td id="stats_max_streak"></td>
                    </tr>
                    <tr>
                        <td>Tode:</td>
                        <td id="stats_deaths"></td>
                    </tr>
                    <tr>
                        <td>Kopfgeld (XP):</td>
                        <td id="stats_bounty"></td>
                    </tr>
                </table>
            </div>
        <script>
            async function get_player(id){
                const response = await fetch(`https://api.ashcon.app/mojang/v2/user/${id}`)
                if (response.ok){
                    let player = await response.json()
                    return [player.uuid, player.username]
                } else {
                    throw new Error("nicht gefunden")
                }
            }

            async function fill_rank(sort_by="xp"){
                const response = await fetch(`https://api.hglabor.de/stats/ffa/top?sort=${sort_by}`)
                if (response.ok){
                    const list = await response.json()
                    all_html = await Promise.all(
                        list.slice(0, 15).map(async (item, index) => {
                            return add_rank_item(index + 1, item)
                        })
                    )
                    document.getElementById("ranks_table").innerHTML += all_html.join("")
                }
            }

            async function add_rank_item(id, player){
                let name = await get_player(player.playerId)
                html = `
                <tr>
                    <td>${id}</td>
                    <td>${name[1]}</td>
                    <td>${player.xp}</td>
                    <td>${player.kills}</td>
                    <td>${player.currentKillStreak}</td>
                    <td>${player.bounty}</td>
                <tr>
                `
                return html
            }

            async function load_stats(){
                input = document.getElementById("input").value
                if (input){
                    let [id, name] = await get_player(input)
                    const response = await fetch(`https://api.hglabor.de/stats/ffa/${id}`)
                    if (!response.ok) throw Error("nicht gefunden")
                    const player = await response.json()
                    document.getElementById("stats_name").innerText = name
                    document.getElementById("stats_xp").innerText = player.xp
                    document.getElementById("stats_kills").innerText = player.kills
                    document.getElementById("stats_streak").innerText = player.currentKillStreak
                    document.getElementById("stats_max_streak").innerText = player.highestKillStreak
                    document.getElementById("stats_deaths").innerText = player.deaths
                    document.getElementById("stats_bounty").innerText = player.bounty
                }
            }

            function switch_view(){
                const rank = document.getElementById("rank")
                const stats = document.getElementById("stats")
                if (rank.style.display === "none"){
                    rank.style.display = "block"
                    stats.style.display = "none"
                    document.getElementById("page").innerText = "Rank"
                } else {
                    stats.style.display = "block"
                    rank.style.display = "none"
                    document.getElementById("page").innerText = "Stats"
                }
            }

            fill_rank()
        </script>
    </body>
</html>
